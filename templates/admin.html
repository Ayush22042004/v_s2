{% extends "base.html" %}
{% block content %}
<h2>Admin Dashboard</h2>

<div class="grid">
  <div style="margin-bottom:8px">
    <a class="btn" href="{{ url_for('admin_candidate_applications') }}">Review Candidate Applications</a>
  </div>
  <div class="card">
    <h3>Schedule Election</h3>
  <form method="POST" action="{{ url_for('schedule_election') }}">
<input type='hidden' name='tz_offset' value='0' />
      <input name="title" placeholder="Election Title" required>
      <label>Year</label>
      <select name="year" required>
        {% for y in range(2023, 2031) %}
          <option value="{{ y }}" {% if y==2025 %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>
      <label>Category</label>
      <select name="category" required>
        <option>General</option><option>Technical</option><option>Cultural</option>
      </select>
      <label>Start</label>
      <input type="datetime-local" name="start_time" required>
      <label>End</label>
      <input type="datetime-local" name="end_time" required>
      <label>Candidate limit (optional)</label>
      <input name="candidate_limit" type="number" min="1">
      <button class="btn primary" type="submit">Schedule</button>
    </form>
    {% if debug_info %}
    <div style="margin-top: 16px; padding: 12px; background-color: #f0f0f0; border-radius: 4px; font-size: 0.9em;">
      <strong>üîç Last Scheduled Election Debug Info:</strong>
      <div style="margin-top: 8px; font-family: monospace;">
        <div><strong>Title:</strong> {{ debug_info.title }}</div>
        <div><strong>Start (UTC stored):</strong> {{ debug_info.start_time_utc }}</div>
        <div><strong>End (UTC stored):</strong> {{ debug_info.end_time_utc }}</div>
        <div><strong>Start (local input):</strong> {{ debug_info.start_time_local }}</div>
        <div><strong>End (local input):</strong> {{ debug_info.end_time_local }}</div>
        <div><strong>TZ Offset:</strong> {{ debug_info.tz_offset }} minutes</div>
      </div>
    </div>
    {% endif %}
  </div>

  <div class="card">
    <h3>Add Candidate</h3>
  <form method="POST" action="{{ url_for('add_candidate') }}" enctype="multipart/form-data">
<input type='hidden' name='tz_offset' value='0' />
      <input name="name" placeholder="Candidate name" required>
      <label>Election</label>
      <select name="election_id" required>
        {% for e in (ongoing + scheduled) %}
          <option value="{{ e.id }}">{{ e.title or e.category }}</option>
        {% else %}
          <option disabled>No eligible election</option>
        {% endfor %}
      </select>
      <input type="file" name="photo" accept="image/*">
      <button class="btn primary" type="submit">Add Candidate</button>
    </form>
  </div>
</div>

<div class="kanban">
  <div>
    <h3>Ongoing</h3>
    <ul>{% for e in ongoing %}
      <li><strong>{{ e.title or e.category }}</strong> ‚Ä¢ {{ e.start_time|istfmt }} ‚Üí {{ e.end_time|istfmt }}</li>
    {% else %}<li class="muted">None</li>{% endfor %}</ul>
  </div>
  <div>
    <h3>Upcoming</h3>
    <ul>{% for e in scheduled %}
      <li>{{ e.title or e.category }} ‚Ä¢ {{ e.start_time|istfmt }}</li>
    {% else %}<li class="muted">None</li>{% endfor %}</ul>
  </div>
  <div>
    <h3>Ended</h3>
    <ul>{% for e in ended %}
      <li>{{ e.title or e.category }} ‚Ä¢ {{ e.start_time|istfmt }} ‚Üí {{ e.end_time|istfmt }}</li>
    {% else %}<li class="muted">None</li>{% endfor %}</ul>
  </div>
  <div>
    <h3>Results</h3>
    <ul>{% for e in ended %}
      <li>{{ e.title or e.category }}
        <a href="{{ url_for('results', election_id=e.id) }}">View Results</a> |
        <a href="{{ url_for('results_excel', eid=e.id) }}">Download Excel</a></li>
    {% else %}<li class="muted">No results available</li>{% endfor %}</ul>
  </div>
</div>
{% endblock %}
<script>
(function(){
  function setTz(){
    const tzEls = document.querySelectorAll('input[name="tz_offset"]');
    tzEls.forEach(e=> e.value = String(new Date().getTimezoneOffset()));
  }
  document.addEventListener('DOMContentLoaded', function(){
    setTz();
    // ensure hidden utc fields on submit
    document.querySelectorAll('form').forEach(function(form){
      form.addEventListener('submit', function(e){
        // update tz just before submit
        setTz();
        form.querySelectorAll('input[type="datetime-local"]').forEach(function(local){
          if(!local.name) return;
          let hidden = form.querySelector('input[name="'+local.name+'_utc"]');
          if(!hidden){
            hidden = document.createElement('input');
            hidden.type = 'hidden';
            hidden.name = local.name + '_utc';
            form.appendChild(hidden);
          }
          const v = local.value;
          if(v){
            // datetime-local value is in format "2025-01-15T10:00"
            // This represents local wall-clock time.
            // Convert to UTC by creating Date object and getting ISO string
            const d = new Date(v);
            if(!isNaN(d)){
              hidden.value = d.toISOString();
            }
          }
        });
      });
    });
  });
})();
</script>
