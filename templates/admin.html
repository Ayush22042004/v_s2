{% extends "base.html" %}
{% block content %}
<h2>Admin Dashboard</h2>

{% if session.get('last_scheduled') %}
<div class="card" style="background-color: #f0f8ff; border: 2px solid #4CAF50; margin-bottom: 16px;">
  <h3 style="color: #4CAF50;">✓ Last Scheduled Election Debug Info</h3>
  <table style="width: 100%; border-collapse: collapse;">
    <tr><td><strong>Title:</strong></td><td>{{ session.last_scheduled.title }}</td></tr>
    <tr><td><strong>Browser Input (Local):</strong></td><td>{{ session.last_scheduled.start_local }} → {{ session.last_scheduled.end_local }}</td></tr>
    <tr><td><strong>TZ Offset Submitted:</strong></td><td>{{ session.last_scheduled.tz_offset }} minutes</td></tr>
    <tr><td><strong>UTC Submitted (JS):</strong></td><td>{{ session.last_scheduled.start_utc_submitted }} → {{ session.last_scheduled.end_utc_submitted }}</td></tr>
    <tr><td><strong>UTC Stored in DB:</strong></td><td>{{ session.last_scheduled.start_utc_stored }} → {{ session.last_scheduled.end_utc_stored }}</td></tr>
    <tr><td><strong>IST Computed (Display):</strong></td><td style="color: #4CAF50; font-weight: bold;">{{ session.last_scheduled.start_ist_computed }} → {{ session.last_scheduled.end_ist_computed }}</td></tr>
  </table>
  <p style="margin-top: 8px; font-size: 0.9em; color: #666;">
    <em>Verify that "IST Computed" matches your intended schedule time. Check the "Upcoming" section below.</em>
  </p>
</div>
{% endif %}

<div class="grid">
  <div style="margin-bottom:8px">
    <a class="btn" href="{{ url_for('admin_candidate_applications') }}">Review Candidate Applications</a>
  </div>
  <div class="card">
    <h3>Schedule Election</h3>
  <form method="POST" action="{{ url_for('schedule_election') }}">
<input type='hidden' name='tz_offset' value='0' />
      <input name="title" placeholder="Election Title" required>
      <label>Year</label>
      <select name="year" required>
        {% for y in range(2023, 2031) %}
          <option value="{{ y }}" {% if y==2025 %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>
      <label>Category</label>
      <select name="category" required>
        <option>General</option><option>Technical</option><option>Cultural</option>
      </select>
      <label>Start</label>
      <input type="datetime-local" name="start_time" required>
      <label>End</label>
      <input type="datetime-local" name="end_time" required>
      <label>Candidate limit (optional)</label>
      <input name="candidate_limit" type="number" min="1">
      <button class="btn primary" type="submit">Schedule</button>
    </form>
  </div>

  <div class="card">
    <h3>Add Candidate</h3>
  <form method="POST" action="{{ url_for('add_candidate') }}" enctype="multipart/form-data">
<input type='hidden' name='tz_offset' value='0' />
      <input name="name" placeholder="Candidate name" required>
      <label>Election</label>
      <select name="election_id" required>
        {% for e in (ongoing + scheduled) %}
          <option value="{{ e.id }}">{{ e.title or e.category }}</option>
        {% else %}
          <option disabled>No eligible election</option>
        {% endfor %}
      </select>
      <input type="file" name="photo" accept="image/*">
      <button class="btn primary" type="submit">Add Candidate</button>
    </form>
  </div>
</div>

<div class="kanban">
  <div>
    <h3>Ongoing</h3>
    <ul>{% for e in ongoing %}
      <li><strong>{{ e.title or e.category }}</strong> • {{ e.start_time|istfmt }} → {{ e.end_time|istfmt }}</li>
    {% else %}<li class="muted">None</li>{% endfor %}</ul>
  </div>
  <div>
    <h3>Upcoming</h3>
    <ul>{% for e in scheduled %}
      <li>{{ e.title or e.category }} • {{ e.start_time|istfmt }}</li>
    {% else %}<li class="muted">None</li>{% endfor %}</ul>
  </div>
  <div>
    <h3>Ended</h3>
    <ul>{% for e in ended %}
      <li>{{ e.title or e.category }} • {{ e.start_time|istfmt }} → {{ e.end_time|istfmt }}</li>
    {% else %}<li class="muted">None</li>{% endfor %}</ul>
  </div>
  <div>
    <h3>Results</h3>
    <ul>{% for e in ended %}
      <li>{{ e.title or e.category }}
        <a href="{{ url_for('results', election_id=e.id) }}">View Results</a> |
        <a href="{{ url_for('results_excel', eid=e.id) }}">Download Excel</a></li>
    {% else %}<li class="muted">No results available</li>{% endfor %}</ul>
  </div>
</div>
{% endblock %}
<script>
(function(){
  function setTz(){
    const tzEls = document.querySelectorAll('input[name="tz_offset"]');
    // For IST (UTC+5:30), getTimezoneOffset() returns -330
    const offset = new Date().getTimezoneOffset();
    tzEls.forEach(e=> e.value = String(offset));
    console.log('[DEBUG] Timezone offset set to:', offset, 'minutes (negative = ahead of UTC)');
  }
  document.addEventListener('DOMContentLoaded', function(){
    setTz();
    // ensure hidden utc fields on submit
    document.querySelectorAll('form').forEach(function(form){
      form.addEventListener('submit', function(e){
        // update tz just before submit
        setTz();
        form.querySelectorAll('input[type="datetime-local"]').forEach(function(local){
          if(!local.name) return;
          let hidden = form.querySelector('input[name="'+local.name+'_utc"]');
          if(!hidden){
            hidden = document.createElement('input');
            hidden.type = 'hidden';
            hidden.name = local.name + '_utc';
            form.appendChild(hidden);
          }
          const v = local.value;
          if(v){
            const d = new Date(v);
            if(!isNaN(d)){
              // CORRECT: new Date(datetime-local value) interprets as local time
              // toISOString() automatically converts to UTC
              hidden.value = d.toISOString();
              console.log('[DEBUG] Converting local time:', v);
              console.log('[DEBUG] Browser local time:', d.toString());
              console.log('[DEBUG] UTC time:', hidden.value);
            }
          }
        });
        // Log all form data for debugging
        const formData = new FormData(form);
        console.log('[DEBUG] Form submission data:');
        for(let [key, value] of formData.entries()){
          if(key.includes('time') || key.includes('tz')){
            console.log('  ', key, '=', value);
          }
        }
      });
    });
  });
})();
</script>
