{% extends "base.html" %}{% block content %}
<h4>Schedule Election</h4>
<form method="post" class="row g-3">
<input type='hidden' name='tz_offset' value='0' />
  <div class="col-md-4"><label class="form-label">Title</label><input name="title" class="form-control" required></div>
  <div class="col-md-4"><label class="form-label">Category</label><input name="category" class="form-control" required></div>
  <div class="col-md-4"><label class="form-label">Candidate limit</label><input name="candidate_limit" type="number" class="form-control" min="1"></div>
  <div class="col-md-6"><label class="form-label">Start (IST)</label><input name="start_time" type="datetime-local" class="form-control" required>
<input type="hidden" name="start_time_utc"></div>
  <div class="col-md-6"><label class="form-label">End (IST)</label><input name="end_time" type="datetime-local" class="form-control" required>
<input type="hidden" name="end_time_utc"></div>
  <div class="col-12"><button class="btn btn-primary">Create</button></div>
</form>

<script>
(function(){
  function setTz(){
    const tzEls = document.querySelectorAll('input[name="tz_offset"]');
    tzEls.forEach(e=> e.value = String(new Date().getTimezoneOffset()));
  }
  document.addEventListener('DOMContentLoaded', function(){
    setTz();
    // ensure hidden utc fields on submit
    document.querySelectorAll('form').forEach(function(form){
      form.addEventListener('submit', function(e){
        // update tz just before submit
        setTz();
        form.querySelectorAll('input[type="datetime-local"]').forEach(function(local){
          if(!local.name) return;
          let hidden = form.querySelector('input[name="'+local.name+'_utc"]');
          if(!hidden){
            hidden = document.createElement('input');
            hidden.type = 'hidden';
            hidden.name = local.name + '_utc';
            form.appendChild(hidden);
          }
          const v = local.value;
          if(v){
            // datetime-local value is in format "2025-01-15T10:00"
            // This represents local wall-clock time.
            // Convert to UTC by creating Date object and getting ISO string
            const d = new Date(v);
            if(!isNaN(d)){
              hidden.value = d.toISOString();
            }
          }
        });
      });
    });
  });
})();
</script>
{% endblock %}
