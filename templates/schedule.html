{% extends "base.html" %}{% block content %}
<h4>Schedule Election</h4>
<form method="post" class="row g-3">
<input type='hidden' name='tz_offset' value='0' />
  <div class="col-md-4"><label class="form-label">Title</label><input name="title" class="form-control" required></div>
  <div class="col-md-4"><label class="form-label">Category</label><input name="category" class="form-control" required></div>
  <div class="col-md-4"><label class="form-label">Candidate limit</label><input name="candidate_limit" type="number" class="form-control" min="1"></div>
  <div class="col-md-6"><label class="form-label">Start (IST)</label><input name="start_time" type="datetime-local" class="form-control" required>
<input type=\"hidden\" name=\"start_time_utc\"></div>
  <div class="col-md-6"><label class="form-label">End (IST)</label><input name="end_time" type="datetime-local" class="form-control" required>
<input type=\"hidden\" name=\"end_time_utc\"></div>
  <div class="col-12"><button class="btn btn-primary">Create</button></div>
</form>
{% endblock %}
<script>
(function(){
  function setTz(){
    const tzEls = document.querySelectorAll('input[name="tz_offset"]');
    // For IST (UTC+5:30), getTimezoneOffset() returns -330
    const offset = new Date().getTimezoneOffset();
    tzEls.forEach(e=> e.value = String(offset));
    console.log('[DEBUG] Timezone offset set to:', offset, 'minutes (negative = ahead of UTC)');
  }
  document.addEventListener('DOMContentLoaded', function(){
    setTz();
    // ensure hidden utc fields on submit
    document.querySelectorAll('form').forEach(function(form){
      form.addEventListener('submit', function(e){
        // update tz just before submit
        setTz();
        form.querySelectorAll('input[type="datetime-local"]').forEach(function(local){
          if(!local.name) return;
          let hidden = form.querySelector('input[name="'+local.name+'_utc"]');
          if(!hidden){
            hidden = document.createElement('input');
            hidden.type = 'hidden';
            hidden.name = local.name + '_utc';
            form.appendChild(hidden);
          }
          const v = local.value;
          if(v){
            const d = new Date(v);
            if(!isNaN(d)){
              // CORRECT: new Date(datetime-local value) interprets as local time
              // toISOString() automatically converts to UTC
              hidden.value = d.toISOString();
              console.log('[DEBUG] Converting local time:', v);
              console.log('[DEBUG] Browser local time:', d.toString());
              console.log('[DEBUG] UTC time:', hidden.value);
            }
          }
        });
        // Log all form data for debugging
        const formData = new FormData(form);
        console.log('[DEBUG] Form submission data:');
        for(let [key, value] of formData.entries()){
          if(key.includes('time') || key.includes('tz')){
            console.log('  ', key, '=', value);
          }
        }
      });
    });
  });
})();
</script>
